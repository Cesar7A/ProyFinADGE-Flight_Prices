
from pyspark.sql import SparkSession
from pyspark.ml.feature import VectorAssembler
from pyspark.ml.regression import LinearRegression
from pyspark.sql.functions import to_date, datediff, split, expr

#define the feature columns
#feature_columns = ["date_difference", "startingAirport","destinationAirport", "elapsedDays", "totalFare",
#                   "isBasicEconomy", "isRefundable", "isNonStop", "seatsRemaining"] 
feature_columns = ["date_difference", "startingAirport","destinationAirport", "elapsedDays", "totalFare",
                   "isBasicEconomy", "isRefundable", "isNonStop"] 
#data = data.withColumn("searchDate", to_date("searchDate", "yyyy-MM-dd"))
data = data.withColumn("date_difference", datediff("flightDate", "searchDate"))
selected_data = data.select(feature_columns)




from pyspark.sql.functions import isnull, count, col, when

null_counts = selected_data.agg(*(count(when(isnull(c), c)).alias(c) for c in selected_data.columns))

# Show the null counts for each column
null_counts.show()



#remove null rows
selected_data = selected_data.dropna()


selected_data.head()


import pandas as pd
import numpy as np
from sklearn.model_selection import train_test_split
from sklearn.preprocessing import OneHotEncoder
from sklearn.linear_model import LinearRegression
from datetime import datetime


# Create DataFrame
df = selected_data.toPandas()

# Calculate date_difference
#df['flightDate'] = pd.to_datetime(df['flightDate'])
#df['searchDate'] = pd.to_datetime(df['searchDate'])
#df['date_difference'] = (df['flightDate'] - df['searchDate']).dt.days

# One-hot encode categorical variables
categorical_cols = ['startingAirport', 'destinationAirport']
encoder = OneHotEncoder(sparse=False)



encoded_cols = pd.DataFrame(encoder.fit_transform(df[categorical_cols]), columns=encoder.get_feature_names_out(categorical_cols))

# Concatenate the encoded columns with the original DataFrame
df = pd.concat([df, encoded_cols], axis=1)
df = df.drop(categorical_cols, axis=1)

# Define features (X) and target (y)
X = df.drop(['totalFare'], axis=1)
y = df['totalFare']

# Split the data into training and testing sets
X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=42)

# Train the linear regression model
model = LinearRegression()
model.fit(X_train, y_train)

# Test the model
y_pred = model.predict(X_test)

# Evaluate the model
r2_score = model.score(X_test, y_test)
print(f'R^2 Score: {r2_score}')



# Convert y and y_pred to DataFrames
y_test_df = y_test.reset_index(drop=True)
y_pred_df = pd.DataFrame(y_pred, columns=['PredictedFare'])

# Concatenate the X_test, y_test, and y_pred DataFrames
results_df = pd.concat([X_test.reset_index(drop=True), y_test_df, y_pred_df], axis=1)

# Calculate the percent difference
results_df['PercentDifference'] = ((results_df['PredictedFare'] - results_df['totalFare']) / results_df['totalFare']) * 100

# Display the results with the new column
print(results_df.columns)



from sklearn.metrics import mean_absolute_error, mean_squared_error

# Calculate Mean Absolute Error (MAE)
mae = mean_absolute_error(y_test, y_pred)

# Calculate Mean Squared Error (MSE)
mse = mean_squared_error(y_test, y_pred)

# Display the evaluation metrics
print(f'R^2 Score: {r2_score}')
print(f'Mean Absolute Error (MAE): {mae}')
print(f'Mean Squared Error (MSE): {mse}')




import pandas as pd
import numpy as np
from datetime import datetime, timedelta
import random

# Define the list of starting and destination airports
airports = ['BOS', 'CLT', 'DEN', 'DFW', 'DTW', 'EWR', 'IAD', 'JFK', 'LAX', 'LGA', 'MIA', 'OAK', 'ORD', 'PHL', 'SFO', 'ATL']

# Generate a list of dates from 11/22/2024 to 12/22/2024
start_date = datetime.strptime('2024-11-22', '%Y-%m-%d')
end_date = datetime.strptime('2024-12-22', '%Y-%m-%d')
date_range = pd.date_range(start_date, end_date)

# Create an empty list to store the records
sim_data = []

# Generate the data
for date in date_range:
    for airport in airports:
        flightDate = date + timedelta(days=random.randint(1, 30))
        searchDate = date
        date_difference = (flightDate - searchDate).days
        startingAirport = airport
        destinationAirport = random.choice([a for a in airports if a != startingAirport])
        elapsedDays = date_difference
        totalFare = random.randint(100, 1000)
        isBasicEconomy = random.randint(0, 1)
        isRefundable = random.randint(0, 1)
        isNonStop = random.randint(0, 1)
        sim_data.append([date_difference, startingAirport, destinationAirport, elapsedDays, totalFare, isBasicEconomy, isRefundable, isNonStop, flightDate, searchDate])

# Create the DataFrame
sim_df = pd.DataFrame(sim_data, columns=["date_difference", "startingAirport", "destinationAirport", "elapsedDays", "totalFare", "isBasicEconomy", "isRefundable", "isNonStop", "flightDate", "searchDate"])

# Display the first few rows of the DataFrame

categorical_cols = ['startingAirport', 'destinationAirport']
encoder = OneHotEncoder(sparse=False)

encoded_cols = pd.DataFrame(encoder.fit_transform(sim_df[categorical_cols]), columns=encoder.get_feature_names_out(categorical_cols))

# Concatenate the encoded columns with the original DataFrame
sim_df = pd.concat([sim_df, encoded_cols], axis=1)
sim_df = sim_df.drop(categorical_cols, axis=1)

# Define features (X) and target (y)
X = sim_df.drop(['totalFare','flightDate','searchDate'], axis=1)
y = sim_df['totalFare']
y_pred = model.predict(X)


# Convert y and y_pred to DataFrames
y_df = y.reset_index(drop=True)
y_pred_df = pd.DataFrame(y_pred, columns=['PredictedFare'])

# Concatenate the X_test, y_test, and y_pred DataFrames
results_df = pd.concat([sim_df.reset_index(drop=True), y_pred_df], axis=1)

results_df

# Write the DataFrame to a CSV file
results_df.to_csv('prediction_data.csv', index=False)





